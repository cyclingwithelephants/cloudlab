
name: Kube diff

on:
  push:
    branches: [ "main" ]
  pull_request:

env:
  PR_DIR: pr
  TARGET_DIR: target
  ENVS_DIR: manifests/groups


jobs:
  kube-diff:
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          path: ${{ env.PR_DIR }}
      - name: Checkout Target of PR
        uses: actions/checkout@v3
        with:
          path: ${{ env.TARGET_DIR }}
          ref: ${{ github.event.pull_request.base.ref }}

      - name: setup kustomize
        shell: bash
        run: curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh"  | bash

    - uses: actions/setup-go@v4
      with:
        go-version: 1.20

    - run: go install cyclingwithelephants/cloudlab/hack/kubediff@latest

    - run: kubediff

    - name: comment PR
      uses: machine-learning-apps/pr-comment@master
      env:
        GITHUB_TOKEN: ${{ github.token }}
      with:
        path: output.txt
