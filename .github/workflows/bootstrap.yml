# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
#  push:
#    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
#  workflow_dispatch:

env:
  CLUSTER_NAME: cloudlab
  CONTROL_PLANE_MACHINE_COUNT: 3
  HCLOUD_CONTROL_PLANE_MACHINE_TYPE: cpx11
  HCLOUD_WORKER_MACHINE_TYPE: cpx11
  HCLOUD_REGION: fsn1
  HCLOUD_SSH_KEY: cluster-nodes
  KUBERNETES_VERSION: 1.25.2
  WORKER_MACHINE_COUNT: 3
  TARGET_CLUSTER_KUBECONFIG: /tmp/target-cluster
  MANAGEMENT_CLUSTER_KUBECONFIG: /tmp/management-cluster
  

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3

      - name: Kind Cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: kind


      # Runs a set of commands using the runners shell
      - name: Install Clusterctl
        run: |
          curl -L https://github.com/kubernetes-sigs/cluster-api/releases/download/v1.4.3/clusterctl-linux-amd64 -o /usr/bin/local/clusterctl
          chmod  +x /usr/bin/local/clusterctl

      - name: Initialise the management cluster
        run: |
          clusterctl init \
            --core cluster-api \
            --bootstrap kubeadm \
            --control-plane kubeadm \
            --infrastructure hetzner 
          
          # wait for management cluster to be ready

      - name: Create HCLOUD token secret
        env:
          HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
          KUBECONFIG: ${{ env.MANAGEMENT_CLUSTER_KUBECONFIG }}
        run: |
          kubectl create secret generic hetzner \
            --from-literal=hcloud=${HCLOUD_TOKEN}
          
          # patch secret so that it gets moved to the managed cluster
          kubectl patch secret hetzner \
            -p '{"metadata":{"labels":{"clusterctl.cluster.x-k8s.io/move":""}}}'

      - name: Create cluster
        env:
          KUBECONFIG: ${{ env.MANAGEMENT_CLUSTER_KUBECONFIG }}
        run: |
          clusterctl generate cluster cloudlab \
            --flavor hcloud-network \
            | kubectl apply -f -
          
          # wait for cluster to be ready
          # for some reason only the first controller comes up before installing everything else
          k wait kubeadmcontrolplane cloudlab-control-plane \
            --for jsonpath='{status.replicas}'=1

      - name: Get kubeconfig
        env:
          KUBECONFIG: ${{ env.MANAGEMENT_CLUSTER_KUBECONFIG }}
        run: |
          clusterctl get kubeconfig cloudlab > ${TARGET_CLUSTER_KUBECONFIG}

      - name: Deploy a CNI
        env:
          KUBECONFIG: ${{ env.TARGET_CLUSTER_KUBECONFIG }}
        run: |
          helm repo add cilium https://helm.cilium.io/

          helm upgrade --install cilium cilium/cilium --version 1.12.2 \
          --namespace kube-system \
          -f https://raw.githubusercontent.com/syself/cluster-api-provider-hetzner/main/templates/cilium/cilium.yaml

      - name: Deploy Hetzner cloud controller manager
        env:
          KUBECONFIG: ${{ env.TARGET_CLUSTER_KUBECONFIG }}
        run: |
          helm repo add syself https://charts.syself.com
          helm repo update syself

          helm upgrade --install ccm syself/ccm-hcloud --version 1.0.11 \
            --namespace kube-system \
            --set secret.name=hetzner \
            --set secret.tokenKeyName=hcloud \
            --set privateNetwork.enabled=true

      - name: Install the metrics server
        env:
          KUBECONFIG: ${{ env.TARGET_CLUSTER_KUBECONFIG }}
        run: |
          kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/high-availability-1.21+.yaml

      - name: Install the Hetzner CSI driver
        env:
          KUBECONFIG: ${{ env.TARGET_CLUSTER_KUBECONFIG }}
        run: |
          cat << EOF > csi-values.yaml
          storageClasses:
          - name: hcloud-volumes
            defaultStorageClass: true
            reclaimPolicy: Retain
          EOF

          helm upgrade --install csi syself/csi-hcloud \
            --version 0.2.0 \
            --namespace kube-system \
            -f csi-values.yaml

          rm csi-values.yaml
